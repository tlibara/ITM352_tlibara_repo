<script src="./products_data.js" type="text/javascript">/* This is an invoice form for the products purchased*/
</script>

<script>
var cart = sessionStorage;
var quantities = [];

if (cart.length == 0) {
  history.go(-1);
  alert ('PLEASE SELECT QUANTITIES, SHOPPING CART IS EMPTY');
};

function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie); 
        var dc = decodedCookie.split(';'); 
        for (var i = 0; i < dc.length; i++) { 
            var d = dc[i];
            while (d.charAt(0) == ' ') {
                d = d.substring(1);
            }
            if (d.indexOf(name) == 0) {
                return c.substring(name.length, d.length);
            }
        }
        return "";
    };

function addItem (theproduct, theindex) {
  var thisRowQty = parseInt(sessionStorage.getItem(`${theproduct}${theindex}`)); 
  thisRowQty += 1; // will add 1
  sessionStorage.setItem(`${theproduct}${theindex}`, thisRowQty); // will show the new value to the session
  window.location.reload(); // will reload the page
};

function removeItem(theproduct, theindex) {
  var thisRowQty = parseInt(sessionStorage.getItem(`${theproduct}${theindex}`));
  if (thisRowQty > 0) {
    thisRowQty -= 1; // will remove 1
    sessionStorage.setItem(`${theproduct}${theindex}`, thisRowQty); // will show the new value to the session
    window.location.reload(); // will reload the page
  }
};

function GoBackWithRefresh(event) { // will take you to previous page
  var past = document.referrer;
  var pastpage = past.split ('/').pop();

  if (pastpage != 'login.html' && pastpage != 'register.html' && pastpage != 'cart.html') {
    window.location = past;
  } else if (pastpage != 'login.html' && pastpage == 'register.html' && pastpage =='cart.html') {
    window.history.go(-2); // will take you back 2 pages 
  } else {
    window.location.href = 'products_display.html'; // will take you to home page
  }
};

function checkCart() {
  if (cart.length == 0) {
    window.location.reload();
  } else if (theusername == '') {
    alert('MUST LOGIN BEFORE VIEWING CART');
    window.location.href = './login.html';
  } else {
    fetch ("/generateInvoice?cartData="+JSON.stringify(cart)+"&cookieData="+JSON.stringify(document.cookie),{
      method: "POST"
    }). then (function(res) {
      return res.text();
    }). then (function (data) {
      document.write(data);
    })
  }
}
</script>
<!DOCTYPE html>
<html>
<title>Invoice</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karma">
<link rel="stylesheet" href="invoice.css">

<!--Borrowed style and portion of template from W3 Schools Food Blog template-->
<style>
  body,
  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: "Karma", sans-serif
  }

  .w3-bar-block .w3-bar-item {
    padding: 20px
  }
</style>

<body>
  <form>

    <!--Name of page and at the top of the page-->
    <header>
      <div style="text-align: center;">
        <h1>TONI'S MAKEUP STORE</h1>
      </div>
    </header>

    <!-- Sidebar (hidden by default), it will also navigate throughout the page -->
    <nav class="w3-sidebar w3-bar-block w3-card w3-top w3-xlarge w3-animate-left"
      style="display:none;z-index:2;width:40%;min-width:300px" id="mySidebar">
      <a href="javascript:void(0)" onclick="w3_close()" class="w3-bar-item w3-button">CLOSE MENU</a>
      <a href="./login.html" onclick="w3_close()" class="w3-bar-item w3-button">LOGIN PAGE</a>
      <a href="./products_display.html" onclick="w3_close()" class="w3-bar-item w3-button">CONTINUE SHOPPING</a>
    </nav>

    <!-- Top menu, includes the navigation sidebar to click on, describes the page, and thanks the customers -->
    <div class="w3-bar-item">
      <div class="w3-white w3-xlarge" style="max-width:1200px;margin:auto">
        <div class="w3-button w3-padding-16 w3-left" onclick="w3_open()">â˜°</div>
        <div class="w3-right w3-padding-16">THANK YOU!</div>
        <div class="w3-center w3-padding-16">SHOPPING CART</div>
      </div>
    </div>
    <br>

    <!-- !PAGE CONTENT! -->
    <main>
      <script >
        var theuser = getCookie ('name');
        var theusername = getCookie ('username');
        if (theusername != '') {
          document.write (`
          <h4 align= "center"> WELCOME ${theusername}, PLEASE REVIEW YOUR ORDER!</h4>
          <h4 align= "center"> NOT ${theusername}, PLEASE LOGIN <a href = "login.html">HERE</a>!</h4>`)
        } else {
          document.write (`
          <h4 align = "center"> OH NO! YOU'RE NOT LOGGED IN, CLICK <a href = "login.html">HERE</a>!</h4>`)
        };
      </script>
      <!-- Table of the invoice, referenced WOD Invoice 4-->

     
      <table>
        <tbody>
          <tr>
            <th style="text-align: center;" width="43%">ITEM</th>
            <th style="text-align: center;" width="11%">QUANTITY</th>
            <th style="text-align: center;" width="13%">PRICE</th>
            <th style="text-align: center;" width="54%">EXTENDED PRICE</th>
          </tr>
          <script>
            subtotal = 0;

            for (product in allproducts) {
              for (i = 0; i < allproducts[product].length; i++) {
                qty = cart.getItem (`${product}${i}`);
                if (qty > 0) {
                  extended_price = qty * allproducts[product][i].price;
                  subtotal += extended_price;

                  document.write(`
                    <tr>
                      <td align="center" width="43%">${allproducts[product][i].name}</td>
                      <td align="center" width="15%">${qty}
                        <input type= "button" class= "button alt" value= "+1" onclick= "addItem('${product}', ${i});">
                        <input type= "button" class= "button alt" value= "-1" onclick= "removeItem('${product}', ${i});">
                      </td>
                      <td align="center" width="13%">\$${products_data[product_key][i].price}</td>
                      <td align="center" width="13%">\$${extended_price}</td>
                    </tr>
                  `);
                }
              }
            }
            // Referenced shipping from WOD Invoice 4, but rearranged values to fit my prices
            // Compute sales tax
            // Hawaii tax rate = 4.712%
            var tax_rate = 0.04712;
            var tax = tax_rate * subtotal;

            // Compute shipping costs
            if (subtotal <= 100) {
              shipping = 5;
            } else if (subtotal <= 200) {
              shipping = 7;
            } else { shipping = 0.04 * subtotal }

            // Compute grand total
            var total = subtotal + tax + shipping;
          </script>

          <tr>
            <td colspan="4" width="100%">&nbsp;</td>
          </tr>
          <tr>
            <td style="text-align: center;" colspan="3" width="67%">SUB-TOTAL</td>
            <td style="text-align: center;" colspan="3" width="54%">$
              <script>
                document.write(subtotal);
              </script>
            </td>
          </tr>
          <tr>
            <td style="text-align: center;" colspan="3" width="67%">TAX @
              <script>document.write(tax_rate.toFixed(4) * 100)</script>
            </td>
            <td style="text-align: center;" colspan="3" width="54%">$
              <script>document.write(tax.toFixed(2));</script>
            </td>
          </tr>
          <tr>
            <td style="text-align: center;" colspan="3" width="67%">SHIPPING</td>
            <td style="text-align: center;" colspan="3" width="54%">$
              <script>document.write(shipping.toFixed(2));</script>
            </td>
          </tr>
          <tr>
            <td style="text-align: center;" colspan="3" width="67%"><strong>TOTAL</strong></td>
            <td style="text-align: center;" colspan="3" width="54%"><span style="font-family: arial;"><strong>$
                  <script>document.write(total.toFixed(2));</script>
                </strong></span></td>
          </tr>
        </tbody>
      </table>
      <div class = buttons>
        <input type="submit" value='CONTINUE SHOPPING' onclick="GoBackWithRefresh()">
        <input type="submit" value="PURCHASE" name="purchasesubmit" onclick="checkcart()">
      </div>

    </main>
    <!-- Footer -->
    <hr id="shipping">
    <footer class="w3-row-padding w3-padding-32">

      <!-- Describe the shipping policy of the store-->
      <div class="w3-row-padding w3-padding-16 w3-center" id="shipping"></div>
      <h3>Shipping Policy</h3>
      <p>OUR SHIPPING POLICY IS: A subtotal of $0 - 99.99 will be $5 shipping, subtotal of $100 - $199.99 will be $5
        shipping, and over $200 will be charged 4% of the subtotal amount. </p>
    </footer>



    <!-- End page content -->
    </div>

    <script>
      // Script to open and close sidebar
      function w3_open() {
        document.getElementById("mySidebar").style.display = "block";
      }

      function w3_close() {
        document.getElementById("mySidebar").style.display = "none";
      }
    </script>
  </form>
</body>

</html>