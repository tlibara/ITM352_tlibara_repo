<script src="./products_data.js" type="text/javascript">/* This is an invoice form for the products purchased*/
</script>
<script>
  let params = (new URL(document.location)).searchParams;

  window.onload = function() {
    if (params.has('LogError')) { // Notify user if there is an error with their username or password
      alert ('FIX USERNAME OR PASSWORD'); 
    }
  }
</script>

<!DOCTYPE html>
<html lang="en">
<head>
  <title>Login</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karma">
  <link rel="stylesheet" href="login.css">
  
  <!--Borrowed style and portion of template from W3 Schools Food Blog template-->
  <style>
    body,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-family: "Karma", sans-serif
    }

    .w3-bar-block .w3-bar-item {
      padding: 20px
    }
  </style>

</head>
<body>
  <!--Name of Store and at the top of the page-->
  <header>
    <div style="text-align: center;">
      <h1>TONI'S MAKEUP STORE</h1>
    </div>
  </header>

  <!-- Sidebar (hidden by default), it will also navigate throughout the page -->
  <nav class="w3-sidebar w3-bar-block w3-card w3-top w3-xlarge w3-animate-left"
    style="display:none;z-index:2;width:40%;min-width:300px" id="mySidebar">
    <a href="javascript:void(0)" onclick="w3_close()" class="w3-bar-item w3-button">CLOSE MENU</a>
    <a href="#pallettes" onclick="w3_close()" class="w3-bar-item w3-button">LOGIN</a>
    <a href="./products_display.html" onclick="w3_close()" class="w3-bar-item w3-button">CONTINUE SHOPPING</a>
  </nav>

  <!-- Top menu, includes the navigation sidebar to click on, describes the page, and purchase button to submit the inputted data -->
  <div class="w3-bar-item">
    <div class="w3-white w3-xlarge" style="max-width:1200px;margin:auto">
      <div class="w3-button w3-padding-16 w3-left" onclick="w3_open()">â˜°</div>
      <div class="w3-right w3-padding-16">ITM352</div>
      <div class="w3-center w3-padding-16">LOGIN</div>
    </div>
  </div>
  <br>
 
  
  <hr id="login">
 
 <form name="loginform" action="javascript:login_user();"  method="GET">
    
  
    <br> 

    <h3>
      Log into our store!
    </h3>
    <!-- Login Section, registered users can input their login information -->
    <div class="containerlogin">
      <label for="username"><b>USERNAME</b></label><br>
      <input type="text" name="username" size="30" placeholder="USERNAME" required><br><br>

      <label for="password"><b>PASSWORD</b></label><br>
      <input type="password" name="password" size="30" placeholder="PASSWORD" onkeyup="" required><br><br>

      <input type="submit" value="LOGIN" name="login" ><br>
    </div>
   </form>
  <!-- If they do not have an account, they can make one by clicking the 'register' link -->
   <form>
    <div class="containerregister">
      <input type="button" name="register" value="REGISTER" onclick="window.location='./register.html' + document.location.search">
    </div>
    </form>
    <br>
    
    <script>
      login.action += document.location.search; // Will save the products in the query string to user in the invoice page
    </script>

    <script>
      function setCookie(cname, cvalue, exdays) {
        var date = new Date();
        date.setTime(date.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires =" + date.toUTCString();
        document.cookie = cname + "=" + cvalue + "=" + expires + ";path=/";
      }

      function deleteAllCookies() {
        var cookies = document.cookie.split(";");
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i];
          var eqPos = cookie.indexOf("=");
          var name = eqPos > -1 ? cookie.substr (0, eqPos) : cookie;
          document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
        }
      };
      function login_user() { 
            data = new URLSearchParams(new FormData(loginform)); 

            fetch('/check_login', 
                {
                    method: 'post',
                    body: data,
                    redirect: 'follow'
                }
            ).then(function (res) { 

                if (res.ok) { 

                    res.json().then(function (errors) {

                        if (Object.keys(errors).length == 0) { 
                            sessionStorage.clear(); 
                            res.json({}); 
                            var theDate = JSON.stringify(Date()); 
                            setCookie('last_login_time', JSON.parse(theDate), 'username'); //remember this login time in cookie
                            
                            res.redirect(GoBackWithRefresh()); //redirect to the last-visited page
                        } else {

                            for (errorId in errors) { // if there are errors associated with the ID message span...
                                document.getElementById(errorId + '_message').innerHTML = errors[errorId]; //write those errors to the appropriate span
                            };

                        };
                    });


                } else {
                    console.log('Network request for /check_login failed with response ' + res.status + ': ' + res.statusText); //notify me in the console if the request didn't go through
                }

            });
        }
    </script>
    <script>
      // Script to open and close sidebar
      function w3_open() {
        document.getElementById("mySidebar").style.display = "block";
      }

      function w3_close() {
        document.getElementById("mySidebar").style.display = "none";
      }
    </script>

  
</body>
</html>